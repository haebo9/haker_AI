# -*- coding: utf-8 -*-
"""TAVILY

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1gEU7MdH6zKrG_BheaC1o8yUAh4w_vHwm
"""

# TAVILY_API_KEY = "" # Paste your API key here

# OPENAI_API_KEY = ""  # ì˜¬ë°”ë¥¸ API í‚¤ë¡œ ë³€ê²½

# !pip install tavily-python
# !pip install langchain_openai

from tavily import TavilyClient
import streamlit as st
from langchain_openai import ChatOpenAI

tavily_client = TavilyClient(TAVILY_API_KEY)
gpt_4o = ChatOpenAI(api_key=OPENAI_API_KEY, model="gpt-4o-mini", temperature=0.1)

st.title("ê³ ë ¹ì ë§ì¶¤ ë³µì•½ ì •ë³´ ì±—ë´‡")

# ì‚¬ìš©ì ì…ë ¥ ë°›ê¸°
medication_name = "ë¶€ë£¨íœ"

# âœ… Step 1: Tavily APIë¥¼ í™œìš©í•œ ë³µì•½ ì •ë³´ ê²€ìƒ‰ í•¨ìˆ˜ ì •ì˜
@st.cache_data
def get_medication_info(medication_name):
    try:
        search_response = tavily_client.search(
            query=f"{medication_name} ë³µì•½ ì •ë³´",
            category="health",  # ê±´ê°• ë° ë³µì•½ ê´€ë ¨ ì •ë³´ ê²€ìƒ‰
            time_range="month"  # ìµœê·¼ 1ê°œì›” ë™ì•ˆì˜ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
        )

        results = search_response.get("results", [])

        # ìœ„í‚¤ë°±ê³¼ ê²€ìƒ‰ ê²°ê³¼ ì¶”ê°€
        wikipedia_search_response = tavily_client.search(
            query=f"{medication_name} ìœ„í‚¤ë°±ê³¼",
            category="encyclopedia",  # ë°±ê³¼ì‚¬ì „ ê²€ìƒ‰
            time_range="month"
        )
        wikipedia_results = wikipedia_search_response.get("results", [])

        results.extend(wikipedia_results)

        if not results:
            return f"'{medication_name}'ì— ëŒ€í•œ ìµœì‹  ë³µì•½ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. "

        # ê²€ìƒ‰ ê²°ê³¼ì—ì„œ URL, ì œëª©, ë‚´ìš©ì„ ê°€ì ¸ì˜´
        response_text = f" **'{medication_name}' ë³µì•½ ì •ë³´**\n\n"
        for result in results[:5]:  # ìƒìœ„ 5ê°œ ê²°ê³¼ë§Œ ì¶œë ¥
            response_text += f" **{result['title']}**\n"
            response_text += f" [ì¶œì²˜]({result['url']})\n"
            response_text += f" {result.get('content', 'ìš”ì•½ ì •ë³´ ì—†ìŒ.')}\n\n"

        return response_text

    except Exception as e:
        return f"âŒ ì˜¤ë¥˜ ë°œìƒ: {e}"

# âœ… Step 2: GPT-4oë¥¼ í™œìš©í•œ ê³ ë ¹ì ë§ì¶¤í˜• ë‹µë³€ ìƒì„±
def generate_chatbot_response(medication_name):
    info = get_medication_info(medication_name)  # âœ… ë³µì•½ ì •ë³´ ê°€ì ¸ì˜¤ê¸°

    prompt = f"""
    ì•ˆë…•í•˜ì„¸ìš”! ì–´ë¥´ì‹ , ë³µì•½ ì •ë³´ë¥¼ ì‰½ê³  ì¹œì ˆí•˜ê²Œ ì•Œë ¤ë“œë¦¬ëŠ” AI ì±—ë´‡ì…ë‹ˆë‹¤.
    '{medication_name}'ì— ëŒ€í•´ ê¶ê¸ˆí•˜ì‹ ê°€ìš”?

     **ì•„ë˜ ë‚´ìš©ì„ ì°¸ê³ í•´ì„œ ì„¤ëª…í•´ ë“œë¦´ê²Œìš”.**
    {info}

    âœ” **ì´ ì•½ì€ ì–´ë–¤ íš¨ê³¼ê°€ ìˆë‚˜ìš”?**
    âœ” **ì–´ë–»ê²Œ ë³µìš©í•´ì•¼ í•˜ë‚˜ìš”?**
    âœ” **ì–´ë–¤ ìŒì‹ì„ í”¼í•´ì•¼ í•˜ë‚˜ìš”?**
    âœ” **ë‹¤ë¥¸ ì•½ê³¼ í•¨ê»˜ ë¨¹ì–´ë„ ê´œì°®ì„ê¹Œìš”?**

    ì–´ë¥´ì‹ ì´ ì´í•´í•˜ê¸° ì‰½ë„ë¡ ì¹œì ˆí•˜ê³  ë¶€ë“œëŸ¬ìš´ ë§íˆ¬ë¡œ ì„¤ëª…í•´ ë“œë¦´ê²Œìš”.
     âœ” **ì´ ì•½ì€ ì–´ë–¤ íš¨ê³¼/íš¨ëŠ¥ ìˆë‚˜ìš”?**
    âœ” **ì–´ë–»ê²Œ ë³µìš©í•˜ë©´ ì¢‹ì„ê¹Œìš”?**
    âœ” **ì£¼ì˜í•  ì ì€ ë¬´ì—‡ì¼ê¹Œìš”?**
    âœ” **ìƒí˜¸ì‘ìš© ëŒ€í•´ ì•Œë ¤ì£¼ì„¸ìš”**

    **ì°¨ê·¼ì°¨ê·¼ ì„¤ëª…í•´ ë“œë¦´ í…Œë‹ˆ í¸í•˜ê²Œ ì½ì–´ì£¼ì„¸ìš”! ğŸ§‘â€âš•ï¸
    **ì–´ë¥´ì‹ ì´ ì‰½ê²Œ ì´í•´í•  ìˆ˜ ìˆë„ë¡ ì¹œì ˆí•˜ê³  ë¶€ë“œëŸ¬ìš´ ë§íˆ¬ë¡œ ì•ˆë‚´í•´ ì£¼ì„¸ìš”.**
    **ë¬¸ì¥ ëì„ "~í•´ìš”"ë¡œ ë§ˆë¬´ë¦¬í•˜ê³ , ì´ëª¨í‹°ì½˜ë„ ì‚¬ìš©í•´ì„œ í¸ì•ˆí•œ ë¶„ìœ„ê¸°ë¥¼ ë§Œë“¤ì–´ ì£¼ì„¸ìš”.**
    **ì‚¬ìš©ìê°€ ì‹ ë¢°í•  ìˆ˜ ìˆë„ë¡ ëª…í™•í•œ ì •ë³´ë§Œ ì œê³µí•´ ì£¼ì„¸ìš”.**
    **ì—†ëŠ” ì •ë³´ëŠ” ì—†ìŠµë‹ˆë‹¤.ë‹¤ì‹œ ì§ˆë¬¸í•´ì£¼ì„¸ìš”!ë¼ê³  ë‹µë³€í•´ì£¼ì„¸ìš”.**
    **ì•½ ì •ë³´ë§Œ ë°›ì•„ì£¼ì„¸ìš”**
    **êµ¬ì²´ì ì¸ ìƒí˜¸ì‘ìš© 
    """

    response = gpt_4o.invoke(prompt)
    return {response.content}

if medication_name:
    response = get_medication_info(medication_name)
    st.markdown(response)
    chatbot_response = generate_chatbot_response(medication_name)
    st.markdown(chatbot_response)

    